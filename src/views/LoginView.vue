<script setup lang="ts">
import router from '@/router';
import { useAuthStore, useMessagesStore } from '@/stores';
import {
  type FormInst,
  type FormValidationError,
  type FormRules,
  NForm,
  NFormItem,
  NInput,
  NButton,
  NCard,
} from 'naive-ui';
import { ref } from 'vue';
import { i18n } from '@/i18n';
import { useWindowSize } from '@vueuse/core';

const t = i18n.global.t;
const auth = useAuthStore();
const messages = useMessagesStore();

const loading = ref(false);
const { width } = useWindowSize();

const initialFormModel = () => ({
  email: null,
  password: null,
});

const formModel = ref<Record<string, string | null>>(initialFormModel());
const formRef = ref<FormInst | null>(null);

const formRules: FormRules = {
  email: [
    {
      required: true,
      message: t('login.rulesFeedback.emailReq'),
      trigger: 'blur',
    },
  ],
  password: [
    {
      required: true,
      message: t('login.rulesFeedback.passwordReq'),
      trigger: 'blur',
    },
  ],
};

function resetForm() {
  loading.value = false;
  formModel.value = initialFormModel();
  formRef.value?.restoreValidation();
}

function switchToRegistration() {
  resetForm();
  router.push('/register');
}

function loginUser() {
  auth
    .login(formModel.value.email || '', formModel.value.password || '')
    .then((u) => {
      resetForm();
      messages.success(t('general.welcome', { name: u.firstName }));
      router.push('/account');
    })
    .catch((e) => {
      /**
       * Unfortunately, the errors returned by the endpoints generated by
       * FastAPI-Users have a weird custom model that we have to handle here...
       */
      if (e.response) {
        const data = e.response.data;
        if (data.detail === 'LOGIN_BAD_CREDENTIALS') {
          messages.error(t('login.errors.badCreds'));
        } else if (data.detail === 'LOGIN_USER_NOT_VERIFIED') {
          messages.error(t('login.errors.notVerified'));
        }
      } else {
        messages.error(t('errors.unexpected'));
      }
      loading.value = false;
    });
}

function handleLoginClick(e: MouseEvent | null = null) {
  e && e.preventDefault();
  loading.value = true;
  formRef.value
    ?.validate((errors: Array<FormValidationError> | undefined) => {
      !errors && loginUser();
    })
    .catch(() => {
      messages.error(t('errors.followFormRules'));
      loading.value = false;
    });
}
</script>

<template>
  <n-card
    embedded
    style="width: 720px; max-width: 100%; margin: 0 auto"
    :title="$t('login.heading')"
    :segmented="{ content: 'soft' }"
    size="huge"
    role="dialog"
    aria-modal="true"
  >
    <n-form
      ref="formRef"
      :model="formModel"
      :rules="formRules"
      size="large"
      :label-placement="width > 600 ? 'left' : 'top'"
      label-width="auto"
      require-mark-placement="right-hanging"
    >
      <n-form-item path="email" :label="$t('login.labels.email')">
        <n-input
          v-model:value="formModel.email"
          type="text"
          :placeholder="$t('login.labels.email')"
          @keydown.enter.prevent
        />
      </n-form-item>
      <n-form-item path="password" :label="$t('login.labels.password')">
        <n-input
          v-model:value="formModel.password"
          type="password"
          :placeholder="$t('login.labels.password')"
          @keyup.enter="() => handleLoginClick()"
        />
      </n-form-item>
    </n-form>

    <template #footer>
      <div style="display: flex; justify-content: flex-end; gap: 12px">
        <n-button
          quaternary
          type="primary"
          size="large"
          :focusable="false"
          tabindex="-1"
          @click="switchToRegistration"
        >
          {{ $t('login.switchToRegister') }}
        </n-button>
        <n-button
          size="large"
          type="primary"
          @click="handleLoginClick"
          :loading="loading"
          :disabled="loading"
        >
          {{ $t('login.login') }}
        </n-button>
      </div>
    </template>
  </n-card>
</template>
